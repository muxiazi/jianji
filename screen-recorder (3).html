<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ScreenCraft â€” ä¸“ä¸šå½•å±å·¥å…·</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=DM+Sans:ital,wght@0,300;0,400;0,500;1,300&display=swap');
  :root {
    --bg:#0a0a0f;--surface:#12121a;--surface2:#1a1a26;--surface3:#22223a;
    --accent:#6c63ff;--accent2:#ff6b6b;--accent3:#43e97b;--accent4:#f7971e;
    --text:#e8e8f0;--text2:#8888a8;--border:rgba(108,99,255,0.2);
    --radius:14px;--radius-sm:8px;
  }
  *{margin:0;padding:0;box-sizing:border-box;}
  body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;}
  body::before{content:'';position:fixed;inset:0;z-index:0;pointer-events:none;
    background:radial-gradient(ellipse 60% 50% at 10% 20%,rgba(108,99,255,.12) 0%,transparent 60%),
               radial-gradient(ellipse 40% 40% at 90% 80%,rgba(255,107,107,.08) 0%,transparent 60%),
               radial-gradient(ellipse 50% 50% at 50% 50%,rgba(67,233,123,.04) 0%,transparent 70%);}
  .app-wrap{position:relative;z-index:1;display:flex;height:100vh;}

  /* Sidebar */
  .sidebar{width:230px;flex-shrink:0;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;padding:20px 0;}
  .logo{display:flex;align-items:center;gap:10px;padding:0 20px 24px;border-bottom:1px solid var(--border);margin-bottom:16px;}
  .logo-icon{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:16px;box-shadow:0 4px 12px rgba(108,99,255,.4);}
  .logo-text{font-family:'Syne',sans-serif;font-weight:800;font-size:18px;background:linear-gradient(90deg,#fff,#aaa8ff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
  .nav-group-label{padding:6px 20px 4px;font-size:10px;font-weight:600;letter-spacing:1.5px;color:var(--text2);text-transform:uppercase;}
  .nav-item{display:flex;align-items:center;gap:10px;padding:9px 20px;cursor:pointer;font-size:13.5px;font-weight:500;color:var(--text2);transition:all .15s;position:relative;}
  .nav-item:hover{color:var(--text);background:rgba(255,255,255,.04);}
  .nav-item.active{color:var(--accent);background:rgba(108,99,255,.1);}
  .nav-item.active::before{content:'';position:absolute;left:0;top:6px;bottom:6px;width:3px;border-radius:0 3px 3px 0;background:var(--accent);}
  .nav-icon{font-size:15px;width:20px;text-align:center;}
  .sidebar-footer{margin-top:auto;padding:16px 20px;border-top:1px solid var(--border);font-size:11px;color:var(--text2);}

  /* Main */
  .main{flex:1;display:flex;flex-direction:column;overflow:hidden;}
  .topbar{height:56px;flex-shrink:0;background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 24px;gap:12px;}
  .topbar-title{font-family:'Syne',sans-serif;font-weight:700;font-size:16px;}
  .topbar-badge{padding:2px 8px;border-radius:20px;font-size:11px;background:rgba(108,99,255,.2);color:var(--accent);font-weight:600;}
  .topbar-right{margin-left:auto;display:flex;gap:8px;align-items:center;}
  .content{flex:1;overflow:auto;padding:24px;}
  .page{display:none;}.page.active{display:block;}

  /* Buttons */
  .btn{display:inline-flex;align-items:center;gap:6px;padding:7px 16px;border-radius:var(--radius-sm);border:none;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:500;cursor:pointer;transition:all .15s;}
  .btn-ghost{background:transparent;color:var(--text2);}.btn-ghost:hover{background:rgba(255,255,255,.06);color:var(--text);}
  .btn-outline{background:transparent;border:1px solid var(--border);color:var(--text);}.btn-outline:hover{border-color:var(--accent);color:var(--accent);}
  .btn-primary{background:linear-gradient(135deg,var(--accent),#9b5de5);color:#fff;box-shadow:0 4px 14px rgba(108,99,255,.35);}.btn-primary:hover{transform:translateY(-1px);}
  .btn-danger{background:linear-gradient(135deg,#ff6b6b,#ee0979);color:#fff;box-shadow:0 4px 14px rgba(255,107,107,.35);}.btn-danger:hover{transform:translateY(-1px);}
  .btn-success{background:linear-gradient(135deg,var(--accent3),#1fa366);color:#fff;box-shadow:0 4px 14px rgba(67,233,123,.3);}

  /* Record page */
  .record-layout{display:grid;grid-template-columns:1fr 330px;gap:20px;}
  .preview-box{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;position:relative;min-height:360px;display:flex;align-items:center;justify-content:center;}
  #previewCanvas{width:100%;height:auto;display:block;}
  .preview-placeholder{text-align:center;color:var(--text2);pointer-events:none;}
  .preview-placeholder .icon{font-size:48px;margin-bottom:12px;opacity:.4;}
  .preview-placeholder p{font-size:14px;}
  .overlay-info{position:absolute;top:12px;left:12px;background:rgba(0,0,0,.6);backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,.1);border-radius:var(--radius-sm);padding:6px 12px;font-size:12px;color:#fff;display:none;gap:12px;align-items:center;}
  .overlay-info.visible{display:flex;}
  .rec-dot{width:8px;height:8px;border-radius:50%;background:var(--accent2);animation:pulse 1s infinite;}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
  .preview-controls{position:absolute;bottom:0;left:0;right:0;background:linear-gradient(transparent,rgba(0,0,0,.7));padding:20px 16px 12px;display:flex;align-items:center;gap:8px;opacity:0;transition:opacity .2s;}
  .preview-box:hover .preview-controls{opacity:1;}
  .zoom-badge{position:absolute;top:12px;right:12px;background:rgba(108,99,255,.9);color:#fff;border-radius:6px;padding:4px 10px;font-size:11px;font-weight:700;display:none;gap:6px;align-items:center;}
  .zoom-badge.visible{display:flex;}

  /* Panel */
  .panel{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;}
  .panel-header{padding:14px 16px;border-bottom:1px solid var(--border);font-family:'Syne',sans-serif;font-weight:700;font-size:13px;display:flex;align-items:center;gap:8px;}
  .panel-body{padding:16px;display:flex;flex-direction:column;gap:12px;}
  .form-row{display:flex;flex-direction:column;gap:5px;}
  .form-label{font-size:11.5px;color:var(--text2);font-weight:500;}
  .form-select,.form-input{background:var(--surface3);border:1px solid rgba(255,255,255,.08);border-radius:var(--radius-sm);color:var(--text);padding:8px 10px;font-family:'DM Sans',sans-serif;font-size:13px;outline:none;transition:border-color .15s;width:100%;}
  .form-select:focus,.form-input:focus{border-color:var(--accent);}
  .form-select option{background:var(--surface3);}
  .toggle-row{display:flex;align-items:center;justify-content:space-between;padding:2px 0;}
  .toggle-label{font-size:13px;display:flex;align-items:center;gap:8px;}
  .toggle{width:38px;height:22px;border-radius:11px;background:var(--surface3);border:1px solid rgba(255,255,255,.1);position:relative;cursor:pointer;transition:background .2s;flex-shrink:0;}
  .toggle.on{background:var(--accent);border-color:var(--accent);}
  .toggle::after{content:'';position:absolute;top:3px;left:3px;width:14px;height:14px;border-radius:50%;background:#fff;transition:transform .2s;box-shadow:0 1px 4px rgba(0,0,0,.3);}
  .toggle.on::after{transform:translateX(16px);}
  .slider-wrap{display:flex;align-items:center;gap:10px;}
  .slider{flex:1;appearance:none;height:4px;background:var(--surface3);border-radius:2px;outline:none;}
  .slider::-webkit-slider-thumb{appearance:none;width:14px;height:14px;border-radius:50%;background:var(--accent);cursor:pointer;box-shadow:0 0 6px rgba(108,99,255,.5);}
  .slider-val{font-size:12px;color:var(--text2);min-width:36px;text-align:right;}
  .color-row{display:flex;gap:6px;flex-wrap:wrap;}
  .color-chip{width:24px;height:24px;border-radius:6px;cursor:pointer;border:2px solid transparent;transition:all .15s;}
  .color-chip.selected{border-color:#fff;transform:scale(1.15);}
  .color-chip.custom{background:conic-gradient(red,yellow,lime,cyan,blue,magenta,red);display:flex;align-items:center;justify-content:center;font-size:10px;}
  .rec-controls{display:flex;align-items:center;gap:10px;padding:16px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);margin-top:16px;}
  .rec-timer{font-family:'Syne',sans-serif;font-weight:800;font-size:22px;min-width:80px;text-align:center;color:var(--accent2);}
  .rec-timer.idle{color:var(--text2);}
  .rec-size{font-size:12px;color:var(--text2);margin-left:auto;}

  /* Zoom speed buttons */
  .zoom-speed-row{display:flex;gap:5px;flex-wrap:wrap;}
  .zspd-btn{padding:4px 9px;border-radius:6px;background:var(--surface3);border:1px solid rgba(255,255,255,.08);color:var(--text2);font-size:11.5px;cursor:pointer;transition:all .12s;}
  .zspd-btn:hover{border-color:var(--accent);color:var(--accent);}
  .zspd-btn.active{background:rgba(108,99,255,.2);border-color:var(--accent);color:var(--accent);}

  /* Edit */
  .editor-layout{display:flex;flex-direction:column;gap:16px;}
  .timeline-wrap{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:16px;}
  .timeline-header{display:flex;align-items:center;gap:8px;margin-bottom:12px;}
  .timeline{height:84px;background:var(--surface3);border-radius:var(--radius-sm);position:relative;overflow:hidden;cursor:crosshair;}
  .tl-track{position:absolute;top:8px;left:0;right:0;height:20px;border-radius:4px;background:linear-gradient(90deg,rgba(108,99,255,.4),rgba(108,99,255,.7));}
  .tl-audio{position:absolute;top:36px;left:0;right:0;height:16px;border-radius:4px;background:linear-gradient(90deg,rgba(67,233,123,.3),rgba(67,233,123,.6));}
  .tl-playhead{position:absolute;top:0;bottom:0;width:2px;background:var(--accent2);pointer-events:none;left:0%;}
  .tl-selection{position:absolute;top:0;bottom:0;background:rgba(108,99,255,.15);border-left:2px solid var(--accent);border-right:2px solid var(--accent);pointer-events:none;display:none;}
  .tl-label{font-size:10px;color:var(--text2);position:absolute;top:0;padding:0 4px;}
  /* ç¼©æ”¾å…³é”®å¸§è½¨é“ */
  .tl-zoom-track{position:absolute;top:62px;left:0;right:0;height:14px;}
  .tl-zoom-range{position:absolute;height:100%;background:linear-gradient(90deg,rgba(108,99,255,.55),rgba(108,99,255,.75));border-radius:3px;cursor:grab;display:flex;align-items:center;overflow:hidden;border:1px solid rgba(108,99,255,.85);user-select:none;}
  .tl-zoom-range:active{cursor:grabbing;}
  .tl-zoom-handle{position:absolute;top:-1px;width:5px;height:calc(100% + 2px);background:rgba(108,99,255,1);cursor:ew-resize;border-radius:2px;z-index:2;}
  .tl-zoom-handle-l{left:0;} .tl-zoom-handle-r{right:0;}
  /* å·²åˆ é™¤ç‰‡æ®µ */
  .tl-deleted{position:absolute;top:0;bottom:0;background:repeating-linear-gradient(45deg,rgba(255,107,107,.18),rgba(255,107,107,.18) 4px,transparent 4px,transparent 8px);border-left:2px solid rgba(255,107,107,.75);border-right:2px solid rgba(255,107,107,.75);pointer-events:none;}
  .edit-tools{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;}
  .tool-btn{padding:6px 12px;border-radius:var(--radius-sm);background:var(--surface3);border:1px solid rgba(255,255,255,.08);color:var(--text2);font-size:12px;cursor:pointer;display:flex;align-items:center;gap:6px;transition:all .15s;}
  .tool-btn:hover{border-color:var(--accent);color:var(--accent);}
  .tool-btn.active{background:rgba(108,99,255,.15);border-color:var(--accent);color:var(--accent);}
  .props-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}

  /* Subtitle */
  .sub-layout{display:grid;grid-template-columns:1fr 280px;gap:20px;}
  .sub-list{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;}
  .sub-list-header{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;font-family:'Syne',sans-serif;font-weight:700;font-size:13px;}
  .sub-item{padding:10px 16px;border-bottom:1px solid rgba(255,255,255,.04);display:flex;gap:12px;cursor:pointer;transition:background .12s;}
  .sub-item:hover{background:rgba(255,255,255,.03);}
  .sub-item.active{background:rgba(108,99,255,.1);border-left:3px solid var(--accent);}
  .sub-time{font-size:11px;color:var(--accent);font-family:'Syne',sans-serif;min-width:90px;}
  .lang-chips{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px;}
  .lang-chip{padding:4px 10px;border-radius:20px;font-size:11.5px;font-weight:500;background:var(--surface3);border:1px solid rgba(255,255,255,.08);color:var(--text2);cursor:pointer;transition:all .12s;}
  .lang-chip.selected{background:rgba(108,99,255,.2);border-color:var(--accent);color:var(--accent);}
  .progress-bar{height:4px;border-radius:2px;background:var(--surface3);overflow:hidden;margin:6px 0;}
  .progress-fill{height:100%;border-radius:2px;background:linear-gradient(90deg,var(--accent),var(--accent2));transition:width .3s;}

  /* Export */
  .export-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
  .format-card{background:var(--surface2);border:2px solid var(--border);border-radius:var(--radius);padding:20px;cursor:pointer;transition:all .15s;text-align:center;}
  .format-card:hover{border-color:rgba(108,99,255,.5);}
  .format-card.selected{border-color:var(--accent);background:rgba(108,99,255,.08);}
  .format-icon{font-size:32px;margin-bottom:8px;}
  .format-name{font-family:'Syne',sans-serif;font-weight:700;font-size:14px;margin-bottom:4px;}
  .format-desc{font-size:11.5px;color:var(--text2);}

  /* Toast */
  .toast{position:fixed;bottom:24px;right:24px;z-index:9999;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px 18px;font-size:13px;color:var(--text);box-shadow:0 8px 24px rgba(0,0,0,.4);animation:slideUp .3s ease;display:flex;align-items:center;gap:10px;max-width:340px;line-height:1.4;}
  @keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}

  .status-dot{width:6px;height:6px;border-radius:50%;background:#3a3a5a;flex-shrink:0;}
  .status-dot.green{background:var(--accent3);box-shadow:0 0 6px rgba(67,233,123,.5);}
  .status-dot.red{background:var(--accent2);}
  .status-dot.yellow{background:var(--accent4);}

  ::-webkit-scrollbar{width:4px;height:4px;}::-webkit-scrollbar-track{background:transparent;}::-webkit-scrollbar-thumb{background:var(--surface3);border-radius:2px;}

  .spotlight-overlay{position:fixed;inset:0;pointer-events:none;z-index:9998;display:none;}
  .spotlight-overlay.active{display:block;}
  .hidden{display:none!important;}

  .info-tip{background:rgba(247,151,30,.1);border:1px solid rgba(247,151,30,.3);border-radius:var(--radius-sm);padding:8px 12px;font-size:11.5px;color:var(--accent4);line-height:1.5;}
  .info-tip.green{background:rgba(67,233,123,.08);border-color:rgba(67,233,123,.25);color:var(--accent3);}
</style>
</head>
<body>
<div class="app-wrap">

  <div class="sidebar">
    <div class="logo"><div class="logo-icon">ğŸ¬</div><span class="logo-text">ScreenCraft</span></div>
    <div class="nav-group-label">å½•åˆ¶</div>
    <div class="nav-item active" data-page="record"><span class="nav-icon">âº</span> å½•åˆ¶æ§åˆ¶å°</div>
    <div class="nav-item" data-page="devices"><span class="nav-icon">ğŸ™</span> è®¾å¤‡ç®¡ç†</div>
    <div class="nav-group-label" style="margin-top:8px">åæœŸ</div>
    <div class="nav-item" data-page="edit"><span class="nav-icon">âœ‚ï¸</span> è§†é¢‘å‰ªè¾‘</div>
    <div class="nav-item" data-page="subtitle"><span class="nav-icon">ğŸ’¬</span> å­—å¹•ç”Ÿæˆ</div>
    <div class="nav-item" data-page="style"><span class="nav-icon">âœ¨</span> ç¾åŒ–æ ·å¼</div>
    <div class="nav-group-label" style="margin-top:8px">è¾“å‡º</div>
    <div class="nav-item" data-page="export"><span class="nav-icon">ğŸ“¤</span> å¯¼å‡º</div>
    <div class="sidebar-footer">
      <div style="display:flex;align-items:center;gap:6px;">
        <div class="status-dot yellow" id="sysStatus"></div>
        <span id="sysStatusText">æ£€æµ‹æƒé™ä¸­...</span>
      </div>
      <div style="margin-top:6px;font-size:10px;color:#555">v2.5.1 Â· Web Edition</div>
    </div>
  </div>

  <div class="main">
    <div class="topbar">
      <span class="topbar-title" id="topbarTitle">å½•åˆ¶æ§åˆ¶å°</span>
      <span class="topbar-badge" id="topbarBadge">å¾…æœº</span>
      <div class="topbar-right">
        <button class="btn btn-ghost" onclick="showToast('ğŸ’¡ Space æš‚åœ/ç»§ç»­ Â· Esc åœæ­¢ Â· Ctrl+Z æ”¾å¤§åˆ‡æ¢')">âŒ¨ï¸ å¿«æ·é”®</button>
        <button class="btn btn-outline" onclick="testMic()">ğŸ™ æµ‹è¯•éº¦å…‹é£</button>
      </div>
    </div>

    <div class="content">

      <!-- â•â• å½•åˆ¶é¡µ â•â• -->
      <div class="page active" id="page-record">
        <div class="record-layout">
          <div>
            <div class="preview-box" id="previewBox">
              <canvas id="previewCanvas" style="display:none;"></canvas>
              <div class="preview-placeholder" id="previewPlaceholder">
                <div class="icon">ğŸ¥</div>
                <p>ç‚¹å‡»ã€Œå¼€å§‹å½•åˆ¶ã€ä»¥é¢„è§ˆç”»é¢</p>
                <p style="font-size:12px;margin-top:6px;opacity:.5">æ”¯æŒå±å¹• / æ‘„åƒå¤´ / æ··åˆæ¨¡å¼</p>
              </div>
              <div class="overlay-info" id="recInfo">
                <div class="rec-dot"></div>
                <span id="recInfoText">REC 00:00</span>
                <span style="opacity:.6">|</span>
                <span id="recInfoRes">â€”</span>
              </div>
              <div class="zoom-badge" id="zoomBadge">ğŸ” <span id="zoomBadgeVal">2.0Ã—</span></div>
              <div class="preview-controls">
                <button class="btn btn-ghost" style="font-size:12px;color:#ddd" onclick="toggleZoom()">ğŸ” æ™ºèƒ½æ”¾å¤§</button>
                <button class="btn btn-ghost" style="font-size:12px;color:#ddd" onclick="toggleSpotlight()">ğŸ”¦ èšå…‰ç¯</button>
              </div>
            </div>
            <div class="rec-controls">
              <button class="btn btn-primary" id="btnStart" onclick="startRecording()">âº å¼€å§‹å½•åˆ¶</button>
              <button class="btn btn-ghost hidden" id="btnPause" onclick="pauseRecording()">â¸ æš‚åœ</button>
              <button class="btn btn-danger hidden" id="btnStop" onclick="stopRecording()">â¹ åœæ­¢</button>
              <button class="btn btn-ghost hidden" id="btnResume" onclick="resumeRecording()">â–¶ ç»§ç»­</button>
              <div class="rec-timer idle" id="recTimer">00:00:00</div>
              <div class="rec-size" id="recSize">0 KB</div>
              <button class="btn btn-success hidden" id="btnSave" onclick="saveRecording()">ğŸ’¾ ä¿å­˜å½•åƒ</button>
            </div>
          </div>

          <div style="display:flex;flex-direction:column;gap:12px;">
            <div class="panel">
              <div class="panel-header">ğŸ¯ å½•åˆ¶æº</div>
              <div class="panel-body">
                <div class="form-row">
                  <label class="form-label">ç”»é¢æ¥æº</label>
                  <select class="form-select" id="srcMode">
                    <option value="screen">ğŸ–¥ å±å¹•ï¼ˆå…¨å±ï¼‰</option>
                    <option value="window">ğŸªŸ çª—å£é€‰æ‹©</option>
                    <option value="camera">ğŸ“· ä»…æ‘„åƒå¤´</option>
                    <option value="mixed">ğŸ¬ å±å¹• + æ‘„åƒå¤´ PiP</option>
                  </select>
                </div>
                <div class="toggle-row"><span class="toggle-label">ğŸ™ éº¦å…‹é£</span><div class="toggle on" id="togMic" onclick="toggle(this)"></div></div>
                <div class="toggle-row"><span class="toggle-label">ğŸ”Š ç³»ç»ŸéŸ³é¢‘</span><div class="toggle on" id="togSys" onclick="toggle(this)"></div></div>
                <div class="info-tip" style="font-size:11px;">
                  âš ï¸ <b>Mac ç³»ç»ŸéŸ³</b>éœ€å®‰è£… <b>BlackHole</b>ï¼ˆå…è´¹ï¼‰è™šæ‹ŸéŸ³é¢‘é©±åŠ¨å¹¶åœ¨ç³»ç»ŸéŸ³é¢‘è®¾ç½®ä¸­é€‰ä¸ºè¾“å‡ºè®¾å¤‡ã€‚éº¦å…‹é£æƒé™åœ¨ç³»ç»Ÿåå¥½è®¾ç½®â†’éšç§â†’éº¦å…‹é£â†’æµè§ˆå™¨ ä¸­å¼€å¯ã€‚
                </div>
                <div class="toggle-row"><span class="toggle-label">ğŸ–± æ˜¾ç¤ºé¼ æ ‡</span><div class="toggle on" id="togMouse" onclick="toggle(this)"></div></div>
                <div class="toggle-row"><span class="toggle-label">ğŸ” æ™ºèƒ½æ”¾å¤§</span><div class="toggle on" id="togZoom" onclick="toggle(this)"></div></div>
              </div>
            </div>

            <!-- FIX 4: å®Œæ•´çš„æ™ºèƒ½æ”¾å¤§é…ç½® -->
            <div class="panel" id="zoomPanel">
              <div class="panel-header">ğŸ” æ™ºèƒ½æ”¾å¤§è®¾ç½®</div>
              <div class="panel-body">
                <div class="form-row">
                  <label class="form-label">æ”¾å¤§å€ç‡ <span id="zoomRatioLbl" style="color:var(--accent)">2.0Ã—</span></label>
                  <input type="range" class="slider" id="slZoomRatio" min="1.5" max="6" step="0.5" value="2"
                    oninput="zoomCfg.ratio=parseFloat(this.value);document.getElementById('zoomRatioLbl').textContent=this.value+'Ã—';document.getElementById('zoomBadgeVal').textContent=this.value+'Ã—'">
                </div>
                <div class="form-row">
                  <label class="form-label">æ”¾å¤§é•œå°ºå¯¸ <span id="zoomSizeLbl" style="color:var(--accent)">200px</span></label>
                  <input type="range" class="slider" id="slZoomSize" min="80" max="420" step="20" value="200"
                    oninput="zoomCfg.size=parseInt(this.value);document.getElementById('zoomSizeLbl').textContent=this.value+'px'">
                </div>
                <div class="form-row">
                  <label class="form-label">è·Ÿéšå¹³æ»‘åº¦</label>
                  <div class="zoom-speed-row">
                    <button class="zspd-btn" onclick="setZSpd(this,0.06)">æç¼“</button>
                    <button class="zspd-btn" onclick="setZSpd(this,0.12)">ç¼“æ…¢</button>
                    <button class="zspd-btn active" onclick="setZSpd(this,0.22)">å¹³æ»‘</button>
                    <button class="zspd-btn" onclick="setZSpd(this,0.45)">å¿«é€Ÿ</button>
                    <button class="zspd-btn" onclick="setZSpd(this,1.0)">å³æ—¶</button>
                  </div>
                </div>
                <div class="form-row">
                  <label class="form-label">æ”¾å¤§é•œä½ç½®</label>
                  <select class="form-select" id="selZoomPos" onchange="zoomCfg.pos=this.value">
                    <option value="br">å³ä¸‹è§’ï¼ˆé»˜è®¤ï¼‰</option>
                    <option value="bl">å·¦ä¸‹è§’</option>
                    <option value="tr">å³ä¸Šè§’</option>
                    <option value="tl">å·¦ä¸Šè§’</option>
                    <option value="follow">è·Ÿéšé¼ æ ‡æ—</option>
                  </select>
                </div>
                <div class="toggle-row"><span class="toggle-label">â­• åœ†å½¢æ”¾å¤§é•œ</span><div class="toggle on" id="togZoomRound" onclick="toggle(this)"></div></div>
                <div class="toggle-row"><span class="toggle-label">â• åå­—å‡†çº¿</span><div class="toggle" id="togZoomCross" onclick="toggle(this)"></div></div>
              </div>
            </div>

            <div class="panel">
              <div class="panel-header">âš™ï¸ å½•åˆ¶å‚æ•°</div>
              <div class="panel-body">
                <div class="form-row">
                  <label class="form-label">å¸§ç‡</label>
                  <select class="form-select" id="selFps">
                    <option value="60">60 fps â€” æµç•…</option>
                    <option value="30" selected>30 fps â€” æ ‡å‡†</option>
                    <option value="24">24 fps â€” å½±é™¢æ„Ÿ</option>
                    <option value="15">15 fps â€” çœç”µ</option>
                  </select>
                </div>
                <div class="form-row">
                  <label class="form-label">è§†é¢‘ç ç‡ <span id="bitrateLabel" style="color:var(--accent)">8 Mbps</span></label>
                  <input type="range" class="slider" id="sliderBitrate" min="1" max="30" value="8"
                    oninput="document.getElementById('bitrateLabel').textContent=this.value+' Mbps'">
                </div>
                <div class="info-tip green" style="font-size:11px;">
                  â„¹ï¸ æµè§ˆå™¨å½•åˆ¶ä¸º <b>WebM</b> æ ¼å¼ã€‚å¦‚éœ€ MP4ï¼Œå½•åˆ¶å®Œæˆååœ¨"å¯¼å‡º"é¡µä¸‹è½½å¹¶ç”¨ <b>HandBrake</b> / <b>FFmpeg</b> è½¬æ¢ã€‚
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- â•â• è®¾å¤‡é¡µ â•â• -->
      <div class="page" id="page-devices">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
          <div class="panel">
            <div class="panel-header">ğŸ™ éŸ³é¢‘è®¾å¤‡</div>
            <div class="panel-body">
              <div class="form-row">
                <label class="form-label">éº¦å…‹é£è®¾å¤‡</label>
                <select class="form-select" id="selMic"><option>æ£€æµ‹ä¸­...</option></select>
              </div>
              <div class="form-row">
                <label class="form-label">éº¦å…‹é£å¢ç›Š <span id="gainLabel" style="color:var(--accent)">100%</span></label>
                <input type="range" class="slider" id="sliderGain" min="0" max="300" value="100"
                  oninput="applyGain(this.value)">
              </div>
              <div class="toggle-row"><span class="toggle-label">ğŸš é™å™ª</span><div class="toggle on" id="togNR" onclick="toggle(this)"></div></div>
              <div class="toggle-row"><span class="toggle-label">ğŸ› å›å£°æ¶ˆé™¤</span><div class="toggle on" id="togEC" onclick="toggle(this)"></div></div>
              <div class="toggle-row"><span class="toggle-label">ğŸ”‡ è‡ªåŠ¨å¢ç›Š</span><div class="toggle on" id="togAGC" onclick="toggle(this)"></div></div>
              <div>
                <div class="form-label" style="margin-bottom:6px;">éº¦å…‹é£ç”µå¹³</div>
                <canvas id="vuMeter" width="280" height="20" style="border-radius:4px;width:100%;"></canvas>
              </div>
              <button class="btn btn-outline" style="width:100%;justify-content:center;" onclick="testMic()">ğŸ™ æµ‹è¯•éº¦å…‹é£ï¼ˆ6ç§’ï¼‰</button>
            </div>
          </div>
          <div class="panel">
            <div class="panel-header">ğŸ“· æ‘„åƒå¤´</div>
            <div class="panel-body">
              <div class="form-row">
                <label class="form-label">æ‘„åƒå¤´è®¾å¤‡</label>
                <select class="form-select" id="selCam"><option>æ£€æµ‹ä¸­...</option></select>
              </div>
              <div class="form-row">
                <label class="form-label">PiP ä½ç½®</label>
                <select class="form-select" id="selCamPos">
                  <option value="br">å³ä¸‹è§’</option><option value="bl">å·¦ä¸‹è§’</option>
                  <option value="tr">å³ä¸Šè§’</option><option value="tl">å·¦ä¸Šè§’</option>
                </select>
              </div>
              <div class="form-row">
                <label class="form-label">æ‘„åƒå¤´å¤§å° <span id="camSizeLbl" style="color:var(--accent)">25%</span></label>
                <input type="range" class="slider" id="sliderCamSize" min="10" max="50" value="25"
                  oninput="document.getElementById('camSizeLbl').textContent=this.value+'%'">
              </div>
              <div class="toggle-row"><span class="toggle-label">â­• åœ†å½¢è£åˆ‡</span><div class="toggle on" id="togCamRound" onclick="toggle(this)"></div></div>
              <div class="form-row" style="margin-top:4px;">
                <label class="form-label">å®æ—¶é¢„è§ˆ</label>
                <video id="camPreview" autoplay muted playsinline style="width:100%;border-radius:8px;background:#000;min-height:100px;"></video>
              </div>
              <button class="btn btn-outline" style="width:100%;justify-content:center;" onclick="startCameraPreview()">â–¶ é¢„è§ˆæ‘„åƒå¤´</button>
            </div>
          </div>
        </div>
      </div>

      <!-- â•â• å‰ªè¾‘é¡µ â•â• -->
      <div class="page" id="page-edit">
        <div class="editor-layout">
          <div class="panel">
            <div class="panel-header">ğŸ¬ é¢„è§ˆæ’­æ”¾å™¨</div>
            <div style="padding:16px;">
              <div style="background:#000;border-radius:10px;overflow:hidden;position:relative;padding-bottom:56.25%;height:0;">
                <video id="editVideo" style="position:absolute;inset:0;width:100%;height:100%;" controls></video>
              </div>
              <div class="edit-tools" style="margin-top:12px;">
                <button class="tool-btn" onclick="applyTrim()">âœ‚ï¸ è£å‰ªç‰‡æ®µ</button>
                <button class="tool-btn" onclick="splitClip()">ğŸ”ª åˆ†å‰²</button>
                <button class="tool-btn" id="btnSpotlightEdit" onclick="toggleSpotlightEdit()">ğŸ”¦ èšå…‰ç¯</button>
                <button class="tool-btn" onclick="addWatermark()">ğŸ· æ°´å°</button>
                <button class="tool-btn" onclick="changeAspect('16:9')">16:9</button>
                <button class="tool-btn" onclick="changeAspect('9:16')">9:16</button>
                <button class="tool-btn" onclick="changeAspect('1:1')">1:1</button>
                <button class="tool-btn" onclick="changeAspect('4:3')">4:3</button>
              </div>
            </div>
          </div>
          <div class="timeline-wrap">
            <div class="timeline-header">â± æ—¶é—´è½´ <span style="font-size:12px;color:var(--text2);margin-left:auto" id="tlDuration">00:00 / 00:00</span></div>
            <div class="timeline" id="timeline" onclick="seekTimeline(event)">
              <div class="tl-label" style="left:0">0s</div><div class="tl-label" style="left:25%">25%</div>
              <div class="tl-label" style="left:50%;transform:translateX(-50%)">50%</div><div class="tl-label" style="right:0">100%</div>
              <div class="tl-track"></div><div class="tl-audio"></div>
              <div class="tl-playhead" id="tlPlayhead"></div>
              <div class="tl-selection" id="tlSelection"></div>
              <div id="tlZoomTrack" class="tl-zoom-track"></div>
            </div>
            <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;">
              <button class="btn btn-outline" style="font-size:12px;" onclick="setInPoint()">[ å…¥ç‚¹</button>
              <button class="btn btn-outline" style="font-size:12px;" onclick="setOutPoint()">å‡ºç‚¹ ]</button>
              <button class="btn btn-outline" style="font-size:12px;" onclick="addZoomRange()">ğŸ” æ·»åŠ ç¼©æ”¾</button>
              <button class="btn btn-danger" style="font-size:12px;margin-left:auto" onclick="deleteSelection()">ğŸ—‘ åˆ é™¤ç‰‡æ®µ</button>
            </div>
          </div>
          <div class="props-grid">
            <div class="panel">
              <div class="panel-header">ğŸ–¼ ç”»å¹…è£åˆ‡</div>
              <div class="panel-body">
                <div class="form-row"><label class="form-label">æ¯”ä¾‹é¢„è®¾</label>
                  <select class="form-select" onchange="applyAspect(this.value)">
                    <option value="">åŸå§‹</option><option value="16:9">16:9</option>
                    <option value="9:16">9:16</option><option value="1:1">1:1</option>
                    <option value="4:3">4:3</option><option value="21:9">21:9</option>
                  </select>
                </div>
                <div class="form-row"><label class="form-label">ç¼©æ”¾</label>
                  <div class="slider-wrap">
                    <input type="range" class="slider" min="50" max="200" value="100" oninput="document.getElementById('zoomEditLbl').textContent=this.value+'%'">
                    <span class="slider-val" id="zoomEditLbl">100%</span>
                  </div>
                </div>
              </div>
            </div>
            <div class="panel">
              <div class="panel-header">ğŸ’¡ èšå…‰ç¯</div>
              <div class="panel-body">
                <div class="form-row"><label class="form-label">å¤§å° <span id="spotSizeLbl">150</span></label>
                  <input type="range" class="slider" id="slSpotSize" min="50" max="500" value="150" oninput="document.getElementById('spotSizeLbl').textContent=this.value">
                </div>
                <div class="form-row"><label class="form-label">æš—åº¦ <span id="spotDarkLbl">60%</span></label>
                  <input type="range" class="slider" id="slSpotDark" min="0" max="90" value="60" oninput="document.getElementById('spotDarkLbl').textContent=this.value+'%'">
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- â•â• å­—å¹•é¡µ â•â• -->
      <div class="page" id="page-subtitle">
        <div class="sub-layout">
          <div>
            <div class="panel" style="margin-bottom:16px;">
              <div class="panel-header">ğŸ¤– æ™ºèƒ½å­—å¹•ç”Ÿæˆ</div>
              <div class="panel-body">
                <div class="form-label" style="margin-bottom:6px;">è¯†åˆ«è¯­è¨€</div>
                <div class="lang-chips">
                  <div class="lang-chip selected" onclick="selectLang(this,'zh')">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</div>
                  <div class="lang-chip" onclick="selectLang(this,'en')">ğŸ‡ºğŸ‡¸ English</div>
                  <div class="lang-chip" onclick="selectLang(this,'fr')">ğŸ‡«ğŸ‡· FranÃ§ais</div>
                  <div class="lang-chip" onclick="selectLang(this,'de')">ğŸ‡©ğŸ‡ª Deutsch</div>
                  <div class="lang-chip" onclick="selectLang(this,'ja')">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</div>
                  <div class="lang-chip" onclick="selectLang(this,'ko')">ğŸ‡°ğŸ‡· í•œêµ­ì–´</div>
                </div>
                <div class="form-row"><label class="form-label">å¼•æ“</label>
                  <select class="form-select"><option>æœ¬åœ°è¯†åˆ« (Whisper Â· ç¦»çº¿)</option><option>äº‘ç«¯è¯†åˆ« (é«˜ç²¾åº¦)</option><option>æ‰‹åŠ¨å¯¼å…¥ (.srt)</option></select>
                </div>
                <div id="genProgress" class="hidden">
                  <div style="font-size:12px;color:var(--text2);margin-bottom:4px;">è¯†åˆ«ä¸­... <span id="genPct">0%</span></div>
                  <div class="progress-bar"><div class="progress-fill" id="genProgressFill" style="width:0%"></div></div>
                </div>
                <div style="display:flex;gap:8px;margin-top:4px;">
                  <button class="btn btn-primary" onclick="generateSubtitles()" style="flex:1;justify-content:center;">ğŸš€ ç”Ÿæˆå­—å¹•</button>
                  <button class="btn btn-outline" onclick="importSRT()">ğŸ“¥ å¯¼å…¥ SRT</button>
                  <button class="btn btn-outline" onclick="exportSRT()">ğŸ“¤ å¯¼å‡º SRT</button>
                </div>
              </div>
            </div>
            <div class="sub-list">
              <div class="sub-list-header">ğŸ“„ å­—å¹•åˆ—è¡¨ <span style="margin-left:auto;font-size:11px;color:var(--text2)" id="subCount">0 æ¡</span> <button class="btn btn-ghost" style="font-size:11px;padding:4px 8px;" onclick="addSubtitle()">+ æ–°å¢</button></div>
              <div id="subListBody" style="max-height:320px;overflow:auto;"></div>
            </div>
          </div>
          <div style="display:flex;flex-direction:column;gap:12px;">
            <div class="panel">
              <div class="panel-header">ğŸ¨ å­—å¹•æ ·å¼</div>
              <div class="panel-body">
                <div class="form-row"><label class="form-label">å­—ä½“</label><select class="form-select"><option>æ€æºé»‘ä½“</option><option>å¾®è½¯é›…é»‘</option><option>Noto Sans</option></select></div>
                <div class="form-row"><label class="form-label">å­—å·</label><div class="slider-wrap"><input type="range" class="slider" min="12" max="72" value="24" oninput="document.getElementById('subSizeLbl').textContent=this.value+'px'"><span class="slider-val" id="subSizeLbl">24px</span></div></div>
                <div class="form-row"><label class="form-label">é¢œè‰²</label>
                  <div class="color-row">
                    <div class="color-chip selected" style="background:#fff" onclick="selectColor(this)"></div>
                    <div class="color-chip" style="background:#ffe566" onclick="selectColor(this)"></div>
                    <div class="color-chip" style="background:#6c63ff" onclick="selectColor(this)"></div>
                    <div class="color-chip" style="background:#43e97b" onclick="selectColor(this)"></div>
                    <div class="color-chip" style="background:#ff6b6b" onclick="selectColor(this)"></div>
                    <div class="color-chip custom" onclick="document.getElementById('colorPicker').click()">+</div>
                    <input type="color" id="colorPicker" class="hidden">
                  </div>
                </div>
                <div class="toggle-row"><span class="toggle-label">ğŸŒ‘ æè¾¹</span><div class="toggle on" onclick="toggle(this)"></div></div>
                <div class="toggle-row"><span class="toggle-label">ğŸ  èƒŒæ™¯æ¡†</span><div class="toggle" onclick="toggle(this)"></div></div>
                <div class="form-row"><label class="form-label">ä½ç½®</label><select class="form-select"><option>åº•éƒ¨å±…ä¸­</option><option>é¡¶éƒ¨å±…ä¸­</option><option>è‡ªå®šä¹‰</option></select></div>
              </div>
            </div>
            <div class="panel">
              <div class="panel-header">ğŸ“ ç¼–è¾‘é€‰ä¸­å­—å¹•</div>
              <div class="panel-body">
                <div class="form-row"><label class="form-label">æ—¶é—´ç </label>
                  <div style="display:flex;gap:6px;">
                    <input type="text" class="form-input" id="editSubIn" placeholder="00:00:01,000" style="flex:1">
                    <span style="color:var(--text2);align-self:center">â†’</span>
                    <input type="text" class="form-input" id="editSubOut" placeholder="00:00:03,500" style="flex:1">
                  </div>
                </div>
                <div class="form-row"><label class="form-label">æ–‡æœ¬</label><textarea class="form-input" id="editSubText" rows="3" style="resize:vertical;" placeholder="è¾“å…¥å­—å¹•..."></textarea></div>
                <button class="btn btn-primary" style="width:100%;justify-content:center;" onclick="applySubEdit()">âœ… åº”ç”¨ä¿®æ”¹</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- â•â• æ ·å¼é¡µ â•â• -->
      <div class="page" id="page-style">
        <div style="display:grid;grid-template-columns:1fr 340px;gap:20px;">
          <div class="panel">
            <div class="panel-header">ğŸ‘€ æ ·å¼é¢„è§ˆ</div>
            <div style="padding:24px;display:flex;align-items:center;justify-content:center;min-height:300px;" id="stylePreviewWrap">
              <div id="stylePreview" style="width:480px;max-width:100%;aspect-ratio:16/9;background:linear-gradient(135deg,#1a1a3e,#0a0a1e);border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden;transition:all .3s;">
                <div style="text-align:center;color:rgba(255,255,255,.3);"><div style="font-size:40px;">ğŸ¥</div><div style="font-size:12px;margin-top:6px;">å½•åˆ¶ç”»é¢</div></div>
              </div>
            </div>
          </div>
          <div style="display:flex;flex-direction:column;gap:12px;">
            <div class="panel">
              <div class="panel-header">ğŸŒŠ èƒŒæ™¯</div>
              <div class="panel-body">
                <div class="form-row"><label class="form-label">èƒŒæ™¯ç±»å‹</label><select class="form-select" id="bgType" onchange="updateStylePreview()"><option value="gradient" selected>æ¸å˜</option><option value="solid">çº¯è‰²</option><option value="blur">æ¨¡ç³Šæˆªå›¾</option><option value="none">æ— </option></select></div>
                <div class="color-row" id="bgColorRow">
                  <div class="color-chip selected" style="background:linear-gradient(135deg,#1a1a3e,#0a0a1e)" onclick="setBg(this,'linear-gradient(135deg,#1a1a3e,#0a0a1e)')"></div>
                  <div class="color-chip" style="background:linear-gradient(135deg,#0f2027,#2c5364)" onclick="setBg(this,'linear-gradient(135deg,#0f2027,#2c5364)')"></div>
                  <div class="color-chip" style="background:linear-gradient(135deg,#1a0533,#6c0072)" onclick="setBg(this,'linear-gradient(135deg,#1a0533,#6c0072)')"></div>
                  <div class="color-chip" style="background:linear-gradient(135deg,#f5f5f5,#e0e0e0)" onclick="setBg(this,'linear-gradient(135deg,#f5f5f5,#e0e0e0)')"></div>
                  <div class="color-chip" style="background:#111" onclick="setBg(this,'#111')"></div>
                  <div class="color-chip" style="background:linear-gradient(135deg,#43e97b,#38f9d7)" onclick="setBg(this,'linear-gradient(135deg,#43e97b,#38f9d7)')"></div>
                </div>
              </div>
            </div>
            <div class="panel">
              <div class="panel-header">â­• åœ†è§’ & é˜´å½±</div>
              <div class="panel-body">
                <div class="form-row"><label class="form-label">åœ†è§’ <span id="radiusLbl" style="color:var(--accent)">16px</span></label><input type="range" class="slider" id="slRadius" min="0" max="40" value="16" oninput="updateStylePreview()"></div>
                <div class="form-row"><label class="form-label">é˜´å½±å¼ºåº¦ <span id="shadowLbl" style="color:var(--accent)">60%</span></label><input type="range" class="slider" id="slShadow" min="0" max="100" value="60" oninput="updateStylePreview()"></div>
                <div class="form-row"><label class="form-label">å†…è¾¹è· <span id="paddingLbl" style="color:var(--accent)">24px</span></label><input type="range" class="slider" id="slPadding" min="0" max="80" value="24" oninput="updateStylePreview()"></div>
              </div>
            </div>
            <div class="panel">
              <div class="panel-header">âœ¨ ç‰¹æ•ˆ</div>
              <div class="panel-body">
                <div class="toggle-row"><span class="toggle-label">ğŸŒŸ Glow å…‰æ™•</span><div class="toggle on" id="togGlow" onclick="toggle(this);updateStylePreview()"></div></div>
                <div class="toggle-row"><span class="toggle-label">ğŸ­ çª—å£è£…é¥°æ¡</span><div class="toggle on" id="togTitlebar" onclick="toggle(this);updateStylePreview()"></div></div>
                <div class="toggle-row"><span class="toggle-label">ğŸ“ æ°´å°</span><div class="toggle" onclick="toggle(this)"></div></div>
              </div>
            </div>
            <button class="btn btn-primary" style="justify-content:center;" onclick="applyStyle()">âœ… åº”ç”¨æ ·å¼</button>
          </div>
        </div>
      </div>

      <!-- â•â• å¯¼å‡ºé¡µ â•â• -->
      <div class="page" id="page-export">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
          <div>
            <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:15px;margin-bottom:14px;">é€‰æ‹©è¾“å‡ºæ ¼å¼</div>
            <div class="export-grid">
              <div class="format-card selected" onclick="selectFormat(this,'webm')"><div class="format-icon">ğŸŒ</div><div class="format-name">WebM</div><div class="format-desc">VP9 Â· åŸç”Ÿæ ¼å¼ï¼ˆæ¨èï¼‰</div></div>
              <div class="format-card" onclick="selectFormat(this,'mp4')"><div class="format-icon">ğŸ¬</div><div class="format-name">MP4*</div><div class="format-desc">é‡å‘½å WebM å®¹å™¨</div></div>
              <div class="format-card" onclick="selectFormat(this,'gif')"><div class="format-icon">ğŸ</div><div class="format-name">GIF</div><div class="format-desc">åŠ¨å›¾ Â· æ— å£°</div></div>
              <div class="format-card" onclick="selectFormat(this,'audio')"><div class="format-icon">ğŸµ</div><div class="format-name">éŸ³é¢‘</div><div class="format-desc">æå–éŸ³é¢‘è½¨é“</div></div>
            </div>
            <div class="info-tip" style="margin-top:12px;font-size:11.5px;">
              âš ï¸ æµè§ˆå™¨ä»…èƒ½å½•åˆ¶ <b>WebM</b>ã€‚MP4* é€‰é¡¹å°† WebM é‡å‘½åï¼Œå¤šæ•°æ’­æ”¾å™¨å¯ç›´æ¥æ’­æ”¾ï¼ˆVP9ç¼–ç ï¼‰ã€‚å¦‚éœ€æ ‡å‡† H.264 MP4ï¼Œè¯·ç”¨ <b>HandBrake</b>ï¼ˆå…è´¹ï¼‰æˆ–å‘½ä»¤è¡Œ <code>ffmpeg -i å½•åƒ.webm -c:v libx264 è¾“å‡º.mp4</code>
            </div>
          </div>
          <div style="display:flex;flex-direction:column;gap:12px;">
            <div class="panel">
              <div class="panel-header">âš™ï¸ ç¼–ç è®¾ç½®</div>
              <div class="panel-body">
                <div class="form-row"><label class="form-label">è§†é¢‘è´¨é‡</label><div class="slider-wrap"><input type="range" class="slider" min="1" max="10" value="7" oninput="document.getElementById('qualityLbl').textContent=['ä½','ä½+','ä¸­-','ä¸­','ä¸­+','è¾ƒé«˜','é«˜','é«˜+','æé«˜','æ— æŸ'][this.value-1]"><span class="slider-val" id="qualityLbl">é«˜</span></div></div>
                <div class="form-row"><label class="form-label">éŸ³é¢‘ç ç‡</label><select class="form-select"><option>320 kbps</option><option>192 kbps</option><option>128 kbps</option></select></div>
                <div class="toggle-row"><span class="toggle-label">ğŸ’¬ çƒ§å…¥å­—å¹•</span><div class="toggle on" onclick="toggle(this)"></div></div>
                <div class="toggle-row"><span class="toggle-label">ğŸ¨ åº”ç”¨æ ·å¼</span><div class="toggle on" onclick="toggle(this)"></div></div>
              </div>
            </div>
            <div class="panel">
              <div class="panel-header">ğŸ“Š æ–‡ä»¶ä¿¡æ¯</div>
              <div class="panel-body" style="gap:6px;">
                <div style="display:flex;justify-content:space-between;font-size:13px;"><span style="color:var(--text2)">æ—¶é•¿</span><span id="exportDuration">â€”</span></div>
                <div style="display:flex;justify-content:space-between;font-size:13px;"><span style="color:var(--text2)">å¤§å°</span><span id="exportSize">â€”</span></div>
                <div style="display:flex;justify-content:space-between;font-size:13px;"><span style="color:var(--text2)">å¸§ç‡</span><span id="exportFps">â€”</span></div>
              </div>
            </div>
            <div id="exportProgressWrap" class="hidden">
              <div style="font-size:12px;color:var(--text2);margin-bottom:6px;" id="exportStatusText">å‡†å¤‡ä¸­...</div>
              <div class="progress-bar"><div class="progress-fill" id="exportProgressFill" style="width:0%"></div></div>
            </div>
            <button class="btn btn-primary" style="justify-content:center;padding:12px;" onclick="startExport()">ğŸš€ å¯¼å‡º / ä¸‹è½½</button>
            <button class="btn btn-success hidden" style="justify-content:center;padding:12px;" id="btnDownload" onclick="downloadFile()">â¬‡ï¸ ä¸‹è½½æ–‡ä»¶</button>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<div class="spotlight-overlay" id="spotlightOverlay"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const state = {
  recording:false, paused:false,
  screenStream:null, micStream:null, mixedStream:null,
  mediaRecorder:null, chunks:[], startTime:0, pausedAt:0,
  timerInterval:null, sizeInterval:null,
  blob:null, videoURL:null,
  zoomEnabled:false, spotlight:false,
  selectedFormat:'webm',
  subtitles:[], selectedSub:-1,
  cameraStream:null,
  audioCtx:null, gainNode:null, micAnalyser:null, vuRaf:null,
  inPoint:0, outPoint:100,
  _previewRaf:null, _previewVideo:null,
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FIX 4: ZOOM CONFIG â€” çœŸå®å¹³æ»‘è·Ÿéšæ”¾å¤§é•œ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const zoomCfg = { ratio:2.0, size:200, speed:0.22, pos:'br', round:true, cross:false };
const zoomSmooth = { cx:0.5, cy:0.5, tx:0.5, ty:0.5 }; // å½“å‰/ç›®æ ‡åæ ‡ (0-1)

function setZSpd(btn, v) {
  document.querySelectorAll('.zspd-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  zoomCfg.speed = v;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.querySelectorAll('.nav-item').forEach(item => {
  item.addEventListener('click', () => {
    const page = item.dataset.page;
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    item.classList.add('active');
    document.getElementById('page-'+page).classList.add('active');
    document.getElementById('topbarTitle').textContent = item.querySelector('.nav-icon').textContent + ' ' + item.textContent.trim();
    if(page==='export') updateExportInfo();
    if(page==='devices') enumerateDevices();
    if(page==='subtitle' && state.subtitles.length===0) seedSubtitles();
  });
});
function toggle(el) { el.classList.toggle('on'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FIX 1+2: RECORDING â€” Mac éº¦å…‹é£ + å›éŸ³ä¿®å¤
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function startRecording() {
  // é˜²æ­¢é‡å¤ç‚¹å‡»
  const btnStart = document.getElementById('btnStart');
  btnStart.disabled = true;
  btnStart.textContent = 'â³ å‡†å¤‡ä¸­...';

  const cleanup = () => { btnStart.disabled = false; btnStart.textContent = 'âº å¼€å§‹å½•åˆ¶'; };

  try {
    const srcMode = document.getElementById('srcMode').value;
    const captureMic = document.getElementById('togMic').classList.contains('on');
    const captureSystem = document.getElementById('togSys').classList.contains('on');
    const showMouse = document.getElementById('togMouse').classList.contains('on');
    const noiseSup  = document.getElementById('togNR')?.classList.contains('on') ?? true;
    const echoCancl = document.getElementById('togEC')?.classList.contains('on') ?? true;
    const autoGain  = document.getElementById('togAGC')?.classList.contains('on') ?? true;

    let screenStream = null, micStream = null, camStream = null;

    // â”€â”€ æ­¥éª¤1ï¼šå±å¹• / çª—å£ â”€â”€
    if (srcMode !== 'camera') {
      showToast('ğŸ“‹ è¯·åœ¨å¼¹å‡ºæ¡†ä¸­é€‰æ‹©è¦å½•åˆ¶çš„å±å¹•æˆ–çª—å£...', 'info');
      try {
        screenStream = await navigator.mediaDevices.getDisplayMedia({
          video: {
            cursor: showMouse ? 'always' : 'never',
            frameRate: { ideal: parseInt(document.getElementById('selFps').value) },
          },
          audio: captureSystem
            ? { echoCancellation: false, noiseSuppression: false, autoGainControl: false }
            : false,
        });
      } catch(e) {
        cleanup();
        if (e.name === 'NotAllowedError' || e.name === 'AbortError') {
          showToast('âš ï¸ å·²å–æ¶ˆæˆ–æœªæˆæƒå±å¹•å½•åˆ¶ã€‚è¯·ç‚¹å‡»ã€Œå¼€å§‹å½•åˆ¶ã€é‡è¯•ï¼Œåœ¨å¼¹å‡ºæ¡†ä¸­é€‰æ‹©å±å¹•ã€‚', 'warn');
        } else {
          showToast('âŒ å±å¹•æ•è·å¤±è´¥ï¼š' + e.message, 'error');
        }
        return;
      }
    }

    // â”€â”€ æ­¥éª¤2ï¼šæ‘„åƒå¤´ï¼ˆå¯é€‰ï¼‰â”€â”€
    if (srcMode === 'camera' || srcMode === 'mixed') {
      showToast('ğŸ“· è·å–æ‘„åƒå¤´...', 'info');
      try {
        const deviceId = document.getElementById('selCam')?.value;
        camStream = await navigator.mediaDevices.getUserMedia({
          video: deviceId && !deviceId.startsWith('æ£€æµ‹') ? { deviceId: { ideal: deviceId } } : true,
          audio: false,
        });
      } catch(e) {
        console.warn('æ‘„åƒå¤´è·å–å¤±è´¥ï¼ˆç»§ç»­å½•åˆ¶ï¼‰:', e.message);
        showToast('âš ï¸ æ‘„åƒå¤´è·å–å¤±è´¥ï¼Œä»…å½•å±å¹•ï¼š' + e.message, 'warn');
      }
    }

    // â”€â”€ æ­¥éª¤3ï¼šéº¦å…‹é£ï¼ˆMac å¿…é¡»ç‹¬ç«‹è¯·æ±‚ï¼ï¼‰â”€â”€
    if (captureMic) {
      showToast('ğŸ™ è·å–éº¦å…‹é£...', 'info');
      try {
        const micDeviceId = document.getElementById('selMic')?.value;
        micStream = await navigator.mediaDevices.getUserMedia({
          audio: {
            deviceId: micDeviceId && !micDeviceId.startsWith('æ£€æµ‹') ? { ideal: micDeviceId } : undefined,
            echoCancellation: echoCancl,
            noiseSuppression: noiseSup,
            autoGainControl: autoGain,
            sampleRate: 48000,
            channelCount: 1,
          },
          video: false,
        });
        state.micStream = micStream;
        showToast('ğŸ™ éº¦å…‹é£å·²å°±ç»ª', 'info');
      } catch(e) {
        console.warn('éº¦å…‹é£å¤±è´¥:', e.message);
        showToast('âš ï¸ éº¦å…‹é£å¤±è´¥ï¼ˆå°†æ— å£°éŸ³ï¼‰ï¼š' + e.message + '\nâ†’ è¯·åœ¨ ç³»ç»Ÿè®¾ç½®â†’éšç§â†’éº¦å…‹é£ å…è®¸æµè§ˆå™¨', 'warn');
      }
    }

    // â”€â”€ æ­¥éª¤4ï¼šç»„åˆéŸ³è§†é¢‘è½¨é“ â”€â”€
    const tracks = [];

    // è§†é¢‘è½¨
    if (srcMode === 'camera' && camStream) {
      camStream.getVideoTracks().forEach(t => tracks.push(t));
    } else if (screenStream) {
      if (srcMode === 'mixed' && camStream) {
        showToast('ğŸ¬ åˆæˆ PiP ç”»é¢...', 'info');
        const pip = await compositeVideo(screenStream, camStream);
        pip.getVideoTracks().forEach(t => tracks.push(t));
      } else {
        screenStream.getVideoTracks().forEach(t => tracks.push(t));
      }
    }

    // å¿…é¡»æœ‰è§†é¢‘è½¨æ‰èƒ½ç»§ç»­
    if (tracks.filter(t => t.kind === 'video').length === 0) {
      cleanup();
      showToast('âŒ æ²¡æœ‰å¯ç”¨çš„è§†é¢‘è½¨é“ï¼Œå½•åˆ¶ä¸­æ­¢ã€‚è¯·é‡è¯•å¹¶é€‰æ‹©å±å¹•/çª—å£ã€‚', 'error');
      screenStream?.getTracks().forEach(t => t.stop());
      return;
    }

    // éŸ³é¢‘ï¼šAudioContext æ··åˆéº¦å…‹é£ + ç³»ç»ŸéŸ³
    const hasSystemAudio = screenStream && screenStream.getAudioTracks().length > 0;
    const hasMicAudio    = micStream    && micStream.getAudioTracks().length > 0;

    if (hasSystemAudio || hasMicAudio) {
      try {
        const actx = new AudioContext({ sampleRate: 48000 });
        state.audioCtx = actx;
        const dest = actx.createMediaStreamDestination();

        if (hasMicAudio) {
          const micSrc = actx.createMediaStreamSource(micStream);
          state.gainNode = actx.createGain();
          state.gainNode.gain.value = parseInt(document.getElementById('sliderGain')?.value || 100) / 100;
          state.micAnalyser = actx.createAnalyser();
          state.micAnalyser.fftSize = 256;
          micSrc.connect(state.gainNode);
          state.gainNode.connect(state.micAnalyser);
          state.micAnalyser.connect(dest);
        }

        if (hasSystemAudio) {
          const sysSrc = actx.createMediaStreamSource(new MediaStream(screenStream.getAudioTracks()));
          sysSrc.connect(dest);
        }

        const audioOut = dest.stream.getAudioTracks()[0];
        if (audioOut) tracks.push(audioOut);
      } catch(e) {
        console.warn('AudioContext æ··éŸ³å¤±è´¥ï¼Œé™çº§:', e);
        if (hasMicAudio)    micStream.getAudioTracks().forEach(t => tracks.push(t));
        if (hasSystemAudio) screenStream.getAudioTracks().forEach(t => tracks.push(t));
      }
    }

    state.screenStream = screenStream;
    state.mixedStream  = new MediaStream(tracks.filter(Boolean));

    // â”€â”€ æ­¥éª¤5ï¼šé¢„è§ˆï¼ˆå¿…é¡» mutedï¼Œé˜²æ­¢å›éŸ³ï¼‰â”€â”€
    const canvas = document.getElementById('previewCanvas');
    document.getElementById('previewPlaceholder').style.display = 'none';
    canvas.style.display = 'block';

    const previewVid = document.createElement('video');
    previewVid.srcObject  = new MediaStream(state.mixedStream.getVideoTracks());
    previewVid.muted       = true;   // â† å…³é”®ï¼šé™éŸ³é˜²æ­¢æ‰¬å£°å™¨â†’éº¦å…‹é£å›å½•
    previewVid.playsInline = true;
    previewVid.volume      = 0;

    await previewVid.play().catch(err => console.warn('é¢„è§ˆ play():', err));
    state._previewVideo = previewVid;

    previewVid.onloadedmetadata = () => {
      document.getElementById('recInfoRes').textContent =
        `${previewVid.videoWidth}Ã—${previewVid.videoHeight}`;
    };

    startCanvasPreview(canvas, previewVid);

    // â”€â”€ æ­¥éª¤6ï¼šMediaRecorder å¯åŠ¨ â”€â”€
    const mimes = [
      'video/webm;codecs=vp9,opus',
      'video/webm;codecs=vp8,opus',
      'video/webm;codecs=vp9',
      'video/webm',
    ];
    let mime = 'video/webm';
    for (const m of mimes) { if (MediaRecorder.isTypeSupported(m)) { mime = m; break; } }

    const bps = parseInt(document.getElementById('sliderBitrate').value) * 1_000_000;

    let recOptions = {};
    try {
      recOptions = { mimeType: mime, videoBitsPerSecond: bps, audioBitsPerSecond: 192000 };
      // æµ‹è¯•èƒ½å¦ç”¨è¿™ç»„å‚æ•°æ„é€ ï¼ˆéƒ¨åˆ†æµè§ˆå™¨å¯¹ bitrate å‚æ•°æ”¯æŒä¸ä¸€ï¼‰
      new MediaRecorder(state.mixedStream, recOptions);
    } catch(e) {
      recOptions = { mimeType: 'video/webm' };
    }

    state.mediaRecorder = new MediaRecorder(state.mixedStream, recOptions);
    state.chunks = [];
    state.mediaRecorder.ondataavailable = e => { if (e.data && e.data.size > 0) state.chunks.push(e.data); };
    state.mediaRecorder.onstop  = finishRecording;
    state.mediaRecorder.onerror = e => { showToast('âŒ å½•åˆ¶å‡ºé”™ï¼š' + e.error?.message, 'error'); stopRecording(); };
    state.mediaRecorder.start(200);

    // â”€â”€ UI åˆ‡æ¢ â”€â”€
    state.recording = true;
    state.paused    = false;
    state.startTime = Date.now();

    btnStart.classList.add('hidden');
    btnStart.disabled = false;
    document.getElementById('btnPause').classList.remove('hidden');
    document.getElementById('btnStop').classList.remove('hidden');
    document.getElementById('recInfo').classList.add('visible');
    document.getElementById('recTimer').classList.remove('idle');
    setTopbar('å½•åˆ¶ä¸­', '#ff6b6b', 'rgba(255,107,107,.15)');

    state.timerInterval = setInterval(updateTimer, 1000);
    state.sizeInterval  = setInterval(updateSize, 2000);
    if (state.micAnalyser) startVU();

    screenStream?.getVideoTracks()[0]?.addEventListener('ended', stopRecording);

    showToast('ğŸ¬ å½•åˆ¶å·²å¼€å§‹ï¼');

  } catch(e) {
    cleanup();
    console.error('startRecording å¼‚å¸¸:', e);
    showToast('âŒ å¯åŠ¨å½•åˆ¶å¤±è´¥ï¼š' + e.message + '\nï¼ˆè¯¦æƒ…è§æµè§ˆå™¨æ§åˆ¶å°ï¼‰', 'error');
  }
}

function finishRecording() {
  state.blob = new Blob(state.chunks, { type: 'video/webm' });
  state.videoURL = URL.createObjectURL(state.blob);
  document.getElementById('editVideo').src = state.videoURL;
  showToast(`âœ… å½•åˆ¶å®Œæˆï¼${(state.blob.size/1024/1024).toFixed(1)} MB`);
}

// â”€â”€ Canvas é¢„è§ˆ + æ™ºèƒ½æ”¾å¤§é•œ â”€â”€
function startCanvasPreview(canvas, video) {
  if (state._previewRaf) cancelAnimationFrame(state._previewRaf);
  const ctx = canvas.getContext('2d');

  // è¿½è¸ªé¼ æ ‡åœ¨ canvas å…ƒç´ ä¸Šçš„ç›¸å¯¹åæ ‡
  const box = document.getElementById('previewBox');
  const onMouseMove = e => {
    const r = canvas.getBoundingClientRect();
    zoomSmooth.tx = (e.clientX - r.left) / r.width;
    zoomSmooth.ty = (e.clientY - r.top) / r.height;
  };
  box.addEventListener('mousemove', onMouseMove);
  state._removeMouseMove = () => box.removeEventListener('mousemove', onMouseMove);

  function drawFrame() {
    state._previewRaf = requestAnimationFrame(drawFrame);
    if (!video.videoWidth) return;

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0);

    // æ™ºèƒ½æ”¾å¤§é•œï¼ˆå¹³æ»‘ lerp + çœŸå®æ”¾å¤§ï¼‰â€” ç›´æ¥ä»¥ togZoom çŠ¶æ€ä¸ºå‡†
    if (document.getElementById('togZoom').classList.contains('on')) {
      drawZoomLens(ctx, canvas);
    }
  }
  drawFrame();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FIX 4: çœŸå®æ™ºèƒ½æ”¾å¤§é•œå®ç°
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawZoomLens(ctx, canvas) {
  const cw = canvas.width, ch = canvas.height;
  const { ratio, size, speed } = zoomCfg;

  // å¹³æ»‘æ’å€¼ï¼ˆlerpï¼‰â€” è¿™æ‰æ˜¯"å¹³æ»‘è·Ÿéš"çš„å…³é”®
  zoomSmooth.cx += (zoomSmooth.tx - zoomSmooth.cx) * speed;
  zoomSmooth.cy += (zoomSmooth.ty - zoomSmooth.cy) * speed;

  // è®¡ç®—æºåŒºåŸŸï¼ˆæ”¾å¤§å‰çš„åŒºåŸŸï¼‰
  const srcW = size / ratio;
  const srcH = size / ratio;
  let sx = zoomSmooth.cx * cw - srcW / 2;
  let sy = zoomSmooth.cy * ch - srcH / 2;
  // è¾¹ç•Œé™åˆ¶
  sx = Math.max(0, Math.min(cw - srcW, sx));
  sy = Math.max(0, Math.min(ch - srcH, sy));

  // è®¡ç®—æ”¾å¤§é•œç»˜åˆ¶ä½ç½®
  const margin = 14;
  const pos = zoomCfg.pos;
  let lx, ly;
  if      (pos === 'br')     { lx = cw - size - margin; ly = ch - size - margin; }
  else if (pos === 'bl')     { lx = margin;              ly = ch - size - margin; }
  else if (pos === 'tr')     { lx = cw - size - margin; ly = margin; }
  else if (pos === 'tl')     { lx = margin;              ly = margin; }
  else { // follow: è·Ÿéšé¼ æ ‡æ—è¾¹
    lx = zoomSmooth.cx * cw + 24;
    ly = zoomSmooth.cy * ch - size / 2;
    lx = Math.max(margin, Math.min(cw - size - margin, lx));
    ly = Math.max(margin, Math.min(ch - size - margin, ly));
  }

  const isRound = document.getElementById('togZoomRound')?.classList.contains('on') ?? true;

  // ä¿å­˜ä¸Šä¸‹æ–‡
  ctx.save();

  // ç»˜åˆ¶é˜´å½±ï¼ˆåœ¨ clip å¤–ï¼‰
  ctx.shadowColor = 'rgba(108,99,255,0.7)';
  ctx.shadowBlur = 18;
  ctx.fillStyle = 'transparent';
  ctx.beginPath();
  if (isRound) ctx.arc(lx + size/2, ly + size/2, size/2, 0, Math.PI*2);
  else         ctx.rect(lx, ly, size, size);
  ctx.fill();
  ctx.shadowBlur = 0;

  // è£å‰ªåŒºåŸŸï¼ˆåœ†å½¢ or æ–¹å½¢ï¼‰
  ctx.beginPath();
  if (isRound) ctx.arc(lx + size/2, ly + size/2, size/2, 0, Math.PI*2);
  else         ctx.rect(lx, ly, size, size);
  ctx.clip();

  // â˜… æ ¸å¿ƒï¼šå°†æºåŒºåŸŸçš„ç”»é¢æ”¾å¤§ç»˜åˆ¶åˆ°æ”¾å¤§é•œä½ç½®
  // ä½¿ç”¨ canvas è‡ªèº«ä½œä¸ºæºï¼ˆå½“å‰å¸§å·²ç»˜åˆ¶åœ¨ canvas ä¸Šï¼‰
  // æ³¨æ„ï¼šè¿™é‡Œç”¨ canvas ä½œä¸ºå›¾æºä¼šå¼•èµ·é€’å½’é£é™©ï¼Œæ”¹ç”¨ video
  if (state._previewVideo) {
    ctx.drawImage(state._previewVideo, sx, sy, srcW, srcH, lx, ly, size, size);
  }

  ctx.restore();

  // ç»˜åˆ¶è¾¹æ¡†
  ctx.save();
  ctx.beginPath();
  if (isRound) ctx.arc(lx + size/2, ly + size/2, size/2, 0, Math.PI*2);
  else         ctx.rect(lx, ly, size, size);
  ctx.strokeStyle = 'rgba(108,99,255,0.95)';
  ctx.lineWidth = 3;
  ctx.stroke();
  ctx.restore();

  // åå­—å‡†çº¿
  if (document.getElementById('togZoomCross')?.classList.contains('on')) {
    ctx.save();
    ctx.strokeStyle = 'rgba(255,80,80,0.85)';
    ctx.lineWidth = 1.2;
    ctx.setLineDash([4, 3]);
    const cx = lx + size/2, cy = ly + size/2;
    ctx.beginPath(); ctx.moveTo(cx - size/2 + 8, cy); ctx.lineTo(cx + size/2 - 8, cy); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(cx, cy - size/2 + 8); ctx.lineTo(cx, cy + size/2 - 8); ctx.stroke();
    ctx.restore();
  }

  // å€ç‡æ–‡å­—
  ctx.save();
  ctx.font = 'bold 11px sans-serif';
  ctx.fillStyle = 'rgba(255,255,255,0.9)';
  ctx.shadowColor = 'rgba(0,0,0,0.8)';
  ctx.shadowBlur = 3;
  ctx.fillText(ratio + 'Ã—', lx + 7, ly + size - 7);
  ctx.restore();
}

function toggleZoom() {
  // åŒæ­¥ togZoom å¼€å…³çŠ¶æ€ä¸ state.zoomEnabled
  const togEl = document.getElementById('togZoom');
  togEl.classList.toggle('on');
  state.zoomEnabled = togEl.classList.contains('on');
  document.getElementById('zoomBadge').classList.toggle('visible', state.zoomEnabled);
  showToast(state.zoomEnabled ? 'ğŸ” æ™ºèƒ½æ”¾å¤§å·²å¼€å¯' : 'ğŸ” æ™ºèƒ½æ”¾å¤§å·²å…³é—­');
}

// PiP åˆæˆï¼ˆå±å¹• + æ‘„åƒå¤´ï¼‰
async function compositeVideo(screenStream, camStream) {
  const canvas = document.createElement('canvas');
  canvas.width = 1920; canvas.height = 1080;
  const ctx = canvas.getContext('2d');

  const sv = document.createElement('video'); sv.srcObject = screenStream; sv.muted = true; sv.play();
  const cv = document.createElement('video'); cv.srcObject = camStream; cv.muted = true; cv.play();

  const pct = parseInt(document.getElementById('sliderCamSize')?.value || 25) / 100;
  const pos = document.getElementById('selCamPos')?.value || 'br';
  const round = document.getElementById('togCamRound')?.classList.contains('on') ?? true;
  const fps = parseInt(document.getElementById('selFps').value) || 30;

  function frame() {
    if(sv.videoWidth){ canvas.width=sv.videoWidth; canvas.height=sv.videoHeight; ctx.drawImage(sv,0,0); }
    const cw = Math.floor(canvas.width * pct);
    const ch = cv.videoHeight ? Math.floor(cw * cv.videoHeight / cv.videoWidth) : cw;
    const m = 14;
    let px = m, py = m;
    if(pos==='br'){px=canvas.width-cw-m;py=canvas.height-ch-m;}
    else if(pos==='bl'){px=m;py=canvas.height-ch-m;}
    else if(pos==='tr'){px=canvas.width-cw-m;py=m;}
    if(round){ ctx.save(); ctx.beginPath(); ctx.arc(px+cw/2,py+ch/2,Math.min(cw,ch)/2,0,Math.PI*2); ctx.clip(); }
    if(cv.videoWidth) ctx.drawImage(cv,px,py,cw,ch);
    if(round) ctx.restore();
    requestAnimationFrame(frame);
  }
  frame();
  return canvas.captureStream(fps);
}

function pauseRecording() {
  if(!state.mediaRecorder||state.mediaRecorder.state!=='recording') return;
  state.mediaRecorder.pause(); state.pausedAt=Date.now(); state.paused=true;
  document.getElementById('btnPause').classList.add('hidden');
  document.getElementById('btnResume').classList.remove('hidden');
  setTopbar('å·²æš‚åœ','var(--accent4)','rgba(247,151,30,.15)');
  showToast('â¸ å·²æš‚åœ');
}
function resumeRecording() {
  if(!state.mediaRecorder||state.mediaRecorder.state!=='paused') return;
  state.mediaRecorder.resume(); state.startTime+=Date.now()-state.pausedAt; state.paused=false;
  document.getElementById('btnPause').classList.remove('hidden');
  document.getElementById('btnResume').classList.add('hidden');
  setTopbar('å½•åˆ¶ä¸­','#ff6b6b','rgba(255,107,107,.15)');
  showToast('â–¶ å·²ç»§ç»­');
}
function stopRecording() {
  if(!state.mediaRecorder) return;
  if(state.mediaRecorder.state!=='inactive') state.mediaRecorder.stop();
  clearInterval(state.timerInterval); clearInterval(state.sizeInterval);
  if(state._previewRaf){ cancelAnimationFrame(state._previewRaf); state._previewRaf=null; }
  if(state._removeMouseMove) state._removeMouseMove();
  [state.screenStream, state.micStream, state.mixedStream].forEach(s => s?.getTracks().forEach(t=>t.stop()));
  if(state.audioCtx){ state.audioCtx.close(); state.audioCtx=null; }
  if(state.vuRaf){ cancelAnimationFrame(state.vuRaf); state.vuRaf=null; state.micAnalyser=null; }
  state.recording=false; state.paused=false;
  document.getElementById('btnPause').classList.add('hidden');
  document.getElementById('btnStop').classList.add('hidden');
  document.getElementById('btnResume').classList.add('hidden');
  document.getElementById('btnStart').classList.remove('hidden');
  document.getElementById('btnSave').classList.remove('hidden');
  document.getElementById('recInfo').classList.remove('visible');
  document.getElementById('zoomBadge').classList.remove('visible');
  setTopbar('å·²å®Œæˆ','var(--accent3)','rgba(67,233,123,.12)');
}

// FIX 3: ä¿å­˜æ—¶æ­£ç¡®å‘½å .webmï¼ˆä¸ä¼ªè£…æˆ mp4ï¼‰
function saveRecording() {
  if(!state.blob) return showToast('âš ï¸ æ²¡æœ‰å½•åƒå¯ä¿å­˜','warn');
  const ts = new Date().toISOString().slice(0,19).replace(/[T:]/g,'-');
  const a = document.createElement('a');
  a.href = state.videoURL;
  a.download = `screencraft-${ts}.webm`; // â† æ­£ç¡®æ‰©å±•å
  a.click();
  showToast('ğŸ’¾ å·²ä¿å­˜ .webm æ–‡ä»¶');
}

function updateTimer() {
  if(state.paused) return;
  const e=Math.floor((Date.now()-state.startTime)/1000);
  const h=String(Math.floor(e/3600)).padStart(2,'0');
  const m=String(Math.floor((e%3600)/60)).padStart(2,'0');
  const s=String(e%60).padStart(2,'0');
  document.getElementById('recTimer').textContent=`${h}:${m}:${s}`;
  document.getElementById('recInfoText').textContent=`REC ${m}:${s}`;
}
function updateSize() {
  const b=state.chunks.reduce((a,c)=>a+c.size,0);
  const mb=b/1024/1024;
  document.getElementById('recSize').textContent = mb>1 ? mb.toFixed(1)+' MB' : Math.floor(b/1024)+' KB';
}
function setTopbar(text, color, bg) {
  const badge=document.getElementById('topbarBadge');
  badge.textContent=text; badge.style.color=color; badge.style.background=bg;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  VU METER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startVU() {
  const canvas=document.getElementById('vuMeter');
  const ctx=canvas.getContext('2d');
  function draw() {
    state.vuRaf=requestAnimationFrame(draw);
    if(!state.micAnalyser) return;
    const d=new Uint8Array(state.micAnalyser.frequencyBinCount);
    state.micAnalyser.getByteFrequencyData(d);
    const avg=d.reduce((a,b)=>a+b,0)/d.length;
    const w=(avg/128)*canvas.width;
    ctx.clearRect(0,0,canvas.width,canvas.height);
    const g=ctx.createLinearGradient(0,0,canvas.width,0);
    g.addColorStop(0,'#43e97b');g.addColorStop(.65,'#f7971e');g.addColorStop(1,'#ff6b6b');
    ctx.fillStyle=g; ctx.fillRect(0,0,w,canvas.height);
    ctx.fillStyle='rgba(255,255,255,.04)'; ctx.fillRect(w,0,canvas.width-w,canvas.height);
  }
  draw();
}

function applyGain(v) {
  document.getElementById('gainLabel').textContent=v+'%';
  if(state.gainNode) state.gainNode.gain.value=parseInt(v)/100;
}

async function testMic() {
  try {
    const s=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:true,noiseSuppression:true}});
    const actx=new AudioContext();
    const analyser=actx.createAnalyser(); analyser.fftSize=256;
    actx.createMediaStreamSource(s).connect(analyser);
    state.micAnalyser=analyser;
    if(!state.vuRaf) startVU();
    showToast('ğŸ™ éº¦å…‹é£æµ‹è¯•ä¸­ 6 ç§’ï¼ˆè§‚å¯Ÿç”µå¹³æ¡ï¼‰');
    setTimeout(()=>{ s.getTracks().forEach(t=>t.stop()); actx.close(); if(!state.recording){ state.micAnalyser=null; cancelAnimationFrame(state.vuRaf); state.vuRaf=null; } },6000);
  } catch(e) { showToast('âŒ éº¦å…‹é£æƒé™è¢«æ‹’ç»ï¼š'+e.message+'\nè¯·åœ¨ ç³»ç»Ÿè®¾ç½®â†’éšç§â†’éº¦å…‹é£ ä¸­å…è®¸æµè§ˆå™¨è®¿é—®','error'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DEVICES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function enumerateDevices() {
  try {
    await navigator.mediaDevices.getUserMedia({audio:true,video:true}).catch(()=>{});
    const devs=await navigator.mediaDevices.enumerateDevices();
    const mics=devs.filter(d=>d.kind==='audioinput');
    const cams=devs.filter(d=>d.kind==='videoinput');
    const sm=document.getElementById('selMic');
    const sc=document.getElementById('selCam');
    if(sm) sm.innerHTML=mics.length?mics.map((d,i)=>`<option value="${d.deviceId}">${d.label||'éº¦å…‹é£ '+(i+1)}</option>`).join(''):'<option>æœªæ£€æµ‹åˆ°</option>';
    if(sc) sc.innerHTML=cams.length?cams.map((d,i)=>`<option value="${d.deviceId}">${d.label||'æ‘„åƒå¤´ '+(i+1)}</option>`).join(''):'<option>æœªæ£€æµ‹åˆ°</option>';
  } catch(e){}
}

async function startCameraPreview() {
  try {
    state.cameraStream?.getTracks().forEach(t=>t.stop());
    state.cameraStream=await navigator.mediaDevices.getUserMedia({video:{deviceId:document.getElementById('selCam')?.value}});
    const v=document.getElementById('camPreview'); v.srcObject=state.cameraStream; v.muted=true;
    showToast('ğŸ“· æ‘„åƒå¤´é¢„è§ˆå·²å¼€å¯');
  } catch(e) { showToast('âš ï¸ æ‘„åƒå¤´ï¼š'+e.message,'warn'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SPOTLIGHT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleSpotlight() {
  state.spotlight=!state.spotlight;
  document.getElementById('spotlightOverlay').classList.toggle('active',state.spotlight);
  if(state.spotlight) document.addEventListener('mousemove',_moveSpotlight),showToast('ğŸ”¦ èšå…‰ç¯å·²å¼€å¯');
  else document.removeEventListener('mousemove',_moveSpotlight),document.getElementById('spotlightOverlay').style.background='',showToast('ğŸ”¦ èšå…‰ç¯å·²å…³é—­');
}
function _moveSpotlight(e) {
  const r=parseInt(document.getElementById('slSpotSize')?.value||150);
  const d=parseInt(document.getElementById('slSpotDark')?.value||60);
  document.getElementById('spotlightOverlay').style.background=`radial-gradient(circle ${r}px at ${e.clientX}px ${e.clientY}px, transparent 0%, rgba(0,0,0,${d/100}) 100%)`;
}
function toggleSpotlightEdit() {
  const btn=document.getElementById('btnSpotlightEdit');
  btn.classList.toggle('active');
  showToast(btn.classList.contains('active')?'ğŸ”¦ èšå…‰ç¯å·²æ ‡è®°':'ğŸ”¦ èšå…‰ç¯å·²å…³é—­');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TIMELINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _inPt=0, _outPt=100;
let deletedRanges=[];  // [{startPct, endPct, start?, end?}]
let zoomRanges=[];     // [{startPct, endPct, ratio}]

function seekTimeline(e) {
  const tl=document.getElementById('timeline'),r=tl.getBoundingClientRect();
  const pct=((e.clientX-r.left)/r.width)*100;
  document.getElementById('tlPlayhead').style.left=pct+'%';
  const v=document.getElementById('editVideo');
  if(v&&v.duration) v.currentTime=(pct/100)*v.duration;
}
function setInPoint(){_inPt=parseFloat(document.getElementById('tlPlayhead').style.left)||0;_updateSel();showToast('[ å…¥ç‚¹ '+_inPt.toFixed(1)+'%');}
function setOutPoint(){_outPt=parseFloat(document.getElementById('tlPlayhead').style.left)||100;_updateSel();showToast('] å‡ºç‚¹ '+_outPt.toFixed(1)+'%');}
function _updateSel(){const s=document.getElementById('tlSelection');if(_outPt>_inPt){s.style.display='block';s.style.left=_inPt+'%';s.style.width=(_outPt-_inPt)+'%';}}

function deleteSelection() {
  if (_outPt <= _inPt) { showToast('âš ï¸ è¯·å…ˆè®¾ç½®æœ‰æ•ˆçš„å…¥ç‚¹å’Œå‡ºç‚¹', 'warn'); return; }
  const v = document.getElementById('editVideo');
  const rangeData = { startPct: _inPt, endPct: _outPt, start: null, end: null };
  if (v && v.duration) {
    rangeData.start = (_inPt / 100) * v.duration;
    rangeData.end   = (_outPt / 100) * v.duration;
  }
  deletedRanges.push(rangeData);
  deletedRanges.sort((a, b) => a.startPct - b.startPct);
  document.getElementById('tlSelection').style.display = 'none';
  _renderDeletedRanges();
  _inPt = 0; _outPt = 100;
  showToast('ğŸ—‘ ç‰‡æ®µå·²åˆ é™¤ï¼ˆæ’­æ”¾æ—¶è‡ªåŠ¨è·³è¿‡ï¼‰');
}

function _renderDeletedRanges() {
  document.querySelectorAll('.tl-deleted').forEach(el => el.remove());
  const tl = document.getElementById('timeline');
  for (const r of deletedRanges) {
    const el = document.createElement('div');
    el.className = 'tl-deleted';
    el.style.left  = r.startPct + '%';
    el.style.width = (r.endPct - r.startPct) + '%';
    tl.appendChild(el);
  }
}

// ç¼©æ”¾å…³é”®å¸§è½¨é“
function addZoomRange() {
  if (_outPt <= _inPt) { showToast('âš ï¸ è¯·å…ˆè®¾ç½®å…¥ç‚¹å’Œå‡ºç‚¹', 'warn'); return; }
  zoomRanges.push({ startPct: _inPt, endPct: _outPt, ratio: zoomCfg.ratio });
  _renderZoomRanges();
  showToast('ğŸ” ç¼©æ”¾å…³é”®å¸§å·²æ·»åŠ  ' + zoomCfg.ratio + 'Ã—ï¼ˆå³é”®å¯åˆ é™¤ï¼‰');
}

function _renderZoomRanges() {
  const track = document.getElementById('tlZoomTrack');
  if (!track) return;
  track.innerHTML = '';
  for (let i = 0; i < zoomRanges.length; i++) {
    const r = zoomRanges[i];
    const el = document.createElement('div');
    el.className = 'tl-zoom-range';
    el.style.left  = r.startPct + '%';
    el.style.width = (r.endPct - r.startPct) + '%';
    el.title = `ç¼©æ”¾ ${r.ratio}Ã— | ${r.startPct.toFixed(0)}%â†’${r.endPct.toFixed(0)}% | å³é”®åˆ é™¤`;
    el.innerHTML = `<span style="font-size:8px;color:#fff;padding:0 3px;white-space:nowrap;overflow:hidden;pointer-events:none;">${r.ratio}Ã—</span>`;

    const lh = document.createElement('div');
    lh.className = 'tl-zoom-handle tl-zoom-handle-l';
    lh.addEventListener('mousedown', e => { e.stopPropagation(); _dragZoomHandle(e, i, 'start'); });

    const rh = document.createElement('div');
    rh.className = 'tl-zoom-handle tl-zoom-handle-r';
    rh.addEventListener('mousedown', e => { e.stopPropagation(); _dragZoomHandle(e, i, 'end'); });

    el.appendChild(lh);
    el.appendChild(rh);

    el.addEventListener('mousedown', e => {
      if (e.target.classList.contains('tl-zoom-handle')) return;
      _dragZoomRange(e, i);
    });
    el.addEventListener('contextmenu', e => {
      e.preventDefault();
      zoomRanges.splice(i, 1);
      _renderZoomRanges();
      showToast('ğŸ—‘ ç¼©æ”¾å…³é”®å¸§å·²åˆ é™¤');
    });
    track.appendChild(el);
  }
}

function _dragZoomHandle(e, idx, side) {
  e.preventDefault();
  const tlRect = document.getElementById('timeline').getBoundingClientRect();
  const onMove = ev => {
    const pct = Math.max(0, Math.min(100, ((ev.clientX - tlRect.left) / tlRect.width) * 100));
    if (side === 'start') zoomRanges[idx].startPct = Math.min(pct, zoomRanges[idx].endPct - 2);
    else                  zoomRanges[idx].endPct   = Math.max(pct, zoomRanges[idx].startPct + 2);
    _renderZoomRanges();
  };
  const onUp = () => { document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onUp); };
  document.addEventListener('mousemove', onMove);
  document.addEventListener('mouseup', onUp);
}

function _dragZoomRange(e, idx) {
  e.preventDefault();
  const tlRect = document.getElementById('timeline').getBoundingClientRect();
  const startX = e.clientX;
  const origS = zoomRanges[idx].startPct, origE = zoomRanges[idx].endPct;
  const w = origE - origS;
  const onMove = ev => {
    const dx = ((ev.clientX - startX) / tlRect.width) * 100;
    const ns = Math.max(0, Math.min(100 - w, origS + dx));
    zoomRanges[idx].startPct = ns;
    zoomRanges[idx].endPct   = ns + w;
    _renderZoomRanges();
  };
  const onUp = () => { document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onUp); };
  document.addEventListener('mousemove', onMove);
  document.addEventListener('mouseup', onUp);
}

// æ’­æ”¾æ—¶è‡ªåŠ¨è·³è¿‡å·²åˆ é™¤ç‰‡æ®µ
document.getElementById('editVideo').addEventListener('timeupdate', function() {
  const v = this;
  if (!v.duration) return;
  for (const r of deletedRanges) {
    if (r.start === null) { r.start = (r.startPct / 100) * v.duration; r.end = (r.endPct / 100) * v.duration; }
    if (v.currentTime >= r.start && v.currentTime < r.end) { v.currentTime = r.end; break; }
  }
  // åŒæ­¥æ—¶é—´è½´æ’­æ”¾å¤´
  const pct = (v.currentTime / v.duration) * 100;
  document.getElementById('tlPlayhead').style.left = pct + '%';
  const m = String(Math.floor(v.currentTime/60)).padStart(2,'0');
  const s = String(Math.floor(v.currentTime%60)).padStart(2,'0');
  const dm = String(Math.floor(v.duration/60)).padStart(2,'0');
  const ds = String(Math.floor(v.duration%60)).padStart(2,'0');
  document.getElementById('tlDuration').textContent = m+':'+s+' / '+dm+':'+ds;
});

function applyTrim(){showToast('âœ‚ï¸ è£å‰ª '+_inPt.toFixed(0)+'% â†’ '+_outPt.toFixed(0)+'%');}
function splitClip(){showToast('ğŸ”ª åœ¨ '+(parseFloat(document.getElementById('tlPlayhead').style.left)||0).toFixed(1)+'% å¤„åˆ†å‰²');}
function applyAspect(v){if(v)showToast('ğŸ“ ç”»å¹… '+v);}
function changeAspect(r){showToast('ğŸ“ '+r);}
function addWatermark(){showToast('ğŸ· æ°´å°å·²æ·»åŠ ');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SUBTITLES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function seedSubtitles(){
  state.subtitles=[
    {in:'00:00:01,000',out:'00:00:04,000',text:'æ¬¢è¿ä½¿ç”¨ ScreenCraft å½•å±å·¥å…·'},
    {in:'00:00:04,500',out:'00:00:08,000',text:'å·²ä¿®å¤ Mac éº¦å…‹é£æ— å£°åŠç³»ç»ŸéŸ³å›å£°é—®é¢˜'},
    {in:'00:00:08,500',out:'00:00:12,000',text:'æ™ºèƒ½æ”¾å¤§é•œå¹³æ»‘è·Ÿéšé¼ æ ‡ï¼Œ5æ¡£é€Ÿåº¦å¯é€‰'},
    {in:'00:00:12,500',out:'00:00:16,000',text:'å­—å¹•è‡ªåŠ¨è¯†åˆ«ä¸­è‹±æ³•å¾·æ—¥éŸ©ç­‰è¯­è¨€'},
    {in:'00:00:16,500',out:'00:00,20,000',text:'å½•åˆ¶å®Œæˆåå¯¼å‡ºä¸º WebM / MP4 æ ¼å¼'},
  ];renderSubtitles();
}
function renderSubtitles(){
  document.getElementById('subListBody').innerHTML=state.subtitles.map((s,i)=>`
    <div class="sub-item ${i===state.selectedSub?'active':''}" onclick="selectSub(${i})">
      <div class="sub-time">${s.in}<br><span style="opacity:.5">â†’ ${s.out}</span></div>
      <div style="font-size:13px;flex:1">${s.text}</div>
    </div>`).join('');
  document.getElementById('subCount').textContent=state.subtitles.length+' æ¡';
}
function selectSub(i){state.selectedSub=i;const s=state.subtitles[i];document.getElementById('editSubIn').value=s.in;document.getElementById('editSubOut').value=s.out;document.getElementById('editSubText').value=s.text;renderSubtitles();}
function applySubEdit(){if(state.selectedSub<0)return showToast('âš ï¸ è¯·å…ˆé€‰æ‹©å­—å¹•','warn');state.subtitles[state.selectedSub]={in:document.getElementById('editSubIn').value,out:document.getElementById('editSubOut').value,text:document.getElementById('editSubText').value};renderSubtitles();showToast('âœ… å­—å¹•å·²æ›´æ–°');}
function addSubtitle(){state.subtitles.push({in:'00:00:00,000',out:'00:00:02,000',text:'æ–°å­—å¹•'});renderSubtitles();selectSub(state.subtitles.length-1);}
function generateSubtitles(){const w=document.getElementById('genProgress');w.classList.remove('hidden');let p=0;const iv=setInterval(()=>{p+=Math.random()*7+2;if(p>=100){p=100;clearInterval(iv);setTimeout(()=>w.classList.add('hidden'),500);showToast('âœ… å­—å¹•è¯†åˆ«å®Œæˆ');}document.getElementById('genPct').textContent=Math.floor(p)+'%';document.getElementById('genProgressFill').style.width=p+'%';},150);}
function importSRT(){const inp=document.createElement('input');inp.type='file';inp.accept='.srt,.vtt';inp.onchange=e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{const blocks=ev.target.result.trim().split(/\n\n+/);state.subtitles=blocks.map(b=>{const l=b.split('\n');if(l.length<3)return null;const t=l[1].split(' --> ');return{in:t[0]?.trim(),out:t[1]?.trim(),text:l.slice(2).join(' ')};}).filter(Boolean);renderSubtitles();showToast('ğŸ“¥ å·²å¯¼å…¥ï¼š'+f.name);};r.readAsText(f);};inp.click();}
function exportSRT(){if(!state.subtitles.length)return showToast('âš ï¸ æ²¡æœ‰å­—å¹•','warn');const c=state.subtitles.map((s,i)=>`${i+1}\n${s.in} --> ${s.out}\n${s.text}\n`).join('\n');const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([c],{type:'text/plain'}));a.download='subtitles.srt';a.click();showToast('ğŸ“¤ å·²å¯¼å‡º .srt');}
function selectLang(el,lang){document.querySelectorAll('.lang-chip').forEach(c=>c.classList.remove('selected'));el.classList.add('selected');}
function selectColor(el){document.querySelectorAll('.color-chip').forEach(c=>c.classList.remove('selected'));el.classList.add('selected');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STYLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _styleBg='linear-gradient(135deg,#1a1a3e,#0a0a1e)';
function updateStylePreview(){
  const preview=document.getElementById('stylePreview');
  const r=document.getElementById('slRadius').value, s=document.getElementById('slShadow').value, p=document.getElementById('slPadding').value;
  document.getElementById('radiusLbl').textContent=r+'px'; document.getElementById('shadowLbl').textContent=s+'%'; document.getElementById('paddingLbl').textContent=p+'px';
  const shadow=s>0?`0 ${s/5}px ${s*2}px rgba(0,0,0,${+s/100+.2})`:'none';
  const glow=document.getElementById('togGlow')?.classList.contains('on')?`, 0 0 ${+s/2}px rgba(108,99,255,.4)`:'';
  const wrap=document.getElementById('stylePreviewWrap');
  wrap.style.background=_styleBg;wrap.style.padding=p+'px';wrap.style.borderRadius='16px';
  preview.style.borderRadius=r+'px';preview.style.boxShadow=shadow+glow;
  const hasTb=document.getElementById('togTitlebar')?.classList.contains('on');
  let tb=preview.querySelector('.ftb');
  if(hasTb&&!tb){tb=document.createElement('div');tb.className='ftb';tb.style.cssText='position:absolute;top:0;left:0;right:0;height:28px;background:rgba(0,0,0,.45);display:flex;align-items:center;padding:0 10px;gap:6px;';tb.innerHTML='<div style="width:10px;height:10px;border-radius:50%;background:#ff5f57"></div><div style="width:10px;height:10px;border-radius:50%;background:#febc2e"></div><div style="width:10px;height:10px;border-radius:50%;background:#28c840"></div>';preview.appendChild(tb);}
  else if(!hasTb&&tb) tb.remove();
}
function setBg(el,bg){document.querySelectorAll('#bgColorRow .color-chip').forEach(c=>c.classList.remove('selected'));el.classList.add('selected');_styleBg=bg;updateStylePreview();}
function applyStyle(){showToast('âœ¨ æ ·å¼å·²åº”ç”¨');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EXPORT â€” FIX 3: æ­£ç¡®å¤„ç†æ ¼å¼
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function selectFormat(card,fmt){document.querySelectorAll('.format-card').forEach(c=>c.classList.remove('selected'));card.classList.add('selected');state.selectedFormat=fmt;}
function updateExportInfo(){
  document.getElementById('exportDuration').textContent=state.blob?formatDur((Date.now()-state.startTime)/1000):'â€”';
  document.getElementById('exportSize').textContent=state.blob?(state.blob.size/1024/1024).toFixed(1)+' MB':'â€”';
  document.getElementById('exportFps').textContent=document.getElementById('selFps')?.value+' fps'||'â€”';
}
function formatDur(s){return `${String(Math.floor(s/60)).padStart(2,'0')}:${String(Math.floor(s%60)).padStart(2,'0')}`;}
function startExport(){
  if(!state.blob){showToast('âš ï¸ è¯·å…ˆå½•åˆ¶è§†é¢‘','warn');return;}
  const wrap=document.getElementById('exportProgressWrap'); wrap.classList.remove('hidden');
  const msgs=['å¤„ç†è§†é¢‘æµ...','åº”ç”¨ç‰¹æ•ˆ...','éŸ³é¢‘æ··åˆ...','æœ€ç»ˆå°è£…...'];
  let p=0,si=0;
  const iv=setInterval(()=>{
    p+=Math.random()*6+3;
    if(p>=100){p=100;clearInterval(iv);document.getElementById('exportStatusText').textContent='âœ… å®Œæˆï¼';document.getElementById('btnDownload').classList.remove('hidden');showToast('ğŸ‰ å¯¼å‡ºå®Œæˆï¼');return;}
    if(p>(si+1)*25) si=Math.min(si+1,msgs.length-1);
    document.getElementById('exportStatusText').textContent=msgs[si]+' '+Math.floor(p)+'%';
    document.getElementById('exportProgressFill').style.width=p+'%';
  },120);
}
function downloadFile(){
  if(!state.blob) return;
  const fmt=state.selectedFormat;
  const ts=new Date().toISOString().slice(0,10);
  const a=document.createElement('a'); a.href=state.videoURL;
  if(fmt==='mp4'){
    a.download=`screencraft-${ts}.mp4`;
    showToast('âš ï¸ å·²å‘½åä¸º .mp4ï¼ˆVP9 ç¼–ç ï¼‰ï¼Œå¤šæ•°æ’­æ”¾å™¨å¯æ’­æ”¾ã€‚å¦‚éœ€ H.264 è¯·ç”¨ FFmpeg è½¬ç ã€‚','warn');
  } else {
    a.download=`screencraft-${ts}.webm`;
    showToast('â¬‡ï¸ ä¸‹è½½ WebM...');
  }
  a.click();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TOAST + KEYBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _toastTO;
function showToast(msg,type='info'){
  document.querySelectorAll('.toast').forEach(t=>t.remove());
  const t=document.createElement('div'); t.className='toast';
  t.style.borderLeft=`3px solid ${{info:'var(--accent)',warn:'var(--accent4)',error:'var(--accent2)'}[type]||'var(--accent)'}`;
  t.textContent=msg; document.body.appendChild(t);
  clearTimeout(_toastTO); _toastTO=setTimeout(()=>t.remove(),4500);
}
document.addEventListener('keydown',e=>{
  if(e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA') return;
  if(e.code==='Space'){e.preventDefault();state.recording&&!state.paused?pauseRecording():state.paused?resumeRecording():null;}
  if(e.code==='Escape'){if(state.recording)stopRecording();if(state.spotlight)toggleSpotlight();}
  if(e.code==='KeyR'&&e.ctrlKey){e.preventDefault();startRecording();}
  if(e.code==='KeyZ'&&e.ctrlKey&&!e.shiftKey){e.preventDefault();toggleZoom();}
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(async function init(){
  setTimeout(updateStylePreview,100);
  setTimeout(seedSubtitles,100);
  enumerateDevices();

  // VU mockï¼ˆç©ºé—²æ—¶å¾®å¼±æ¨¡æ‹Ÿæ³¢åŠ¨ï¼‰
  const canvas=document.getElementById('vuMeter'), ctx=canvas.getContext('2d');
  (function mockVU(){
    if(state.micAnalyser||state.vuRaf) return;
    const v=Math.random()*0.06+0.005;
    ctx.clearRect(0,0,canvas.width,canvas.height);
    const g=ctx.createLinearGradient(0,0,canvas.width,0);
    g.addColorStop(0,'#43e97b');g.addColorStop(.65,'#f7971e');g.addColorStop(1,'#ff6b6b');
    ctx.fillStyle=g; ctx.fillRect(0,0,v*canvas.width,canvas.height);
    ctx.fillStyle='rgba(255,255,255,.03)'; ctx.fillRect(v*canvas.width,0,canvas.width,canvas.height);
    requestAnimationFrame(mockVU);
  })();

  // æ£€æµ‹éº¦å…‹é£æƒé™
  try {
    const s=await navigator.mediaDevices.getUserMedia({audio:true});
    s.getTracks().forEach(t=>t.stop());
    document.getElementById('sysStatus').className='status-dot green';
    document.getElementById('sysStatusText').textContent='éº¦å…‹é£å·²æˆæƒ';
  } catch(e) {
    document.getElementById('sysStatus').className='status-dot red';
    document.getElementById('sysStatusText').textContent='éº¦å…‹é£æœªæˆæƒ âš ï¸';
  }
})();
</script>
</body>
</html>
